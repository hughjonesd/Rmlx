<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Project: Rmlx • Rmlx</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Project: Rmlx"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">Rmlx</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/getting-started.html">Getting Started with Rmlx</a></li>
    <li><a class="dropdown-item" href="articles/performance.html">Performance Benchmarks</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Project: Rmlx</h1>

    </div>

<div id="project-rmlx" class="section level1">

<div class="section level2">
<h2 id="high-level-scope-for-the-agent">High-level scope (for the agent)<a class="anchor" aria-label="anchor" href="#high-level-scope-for-the-agent"></a></h2>
<ul><li>Language: R (+ C++ via Rcpp).</li>
<li>OS: macOS on Apple Silicon (Metal backend). Cross-platform explicitly <strong>out of scope</strong> now.</li>
<li>Dependency: Apple MLX C/C++ library (present on system). We’ll <strong>not</strong> vendor MLX; we’ll detect and link to it.</li>
<li>Core object: S3 class <code>mlx</code> wrapping an external pointer to an MLX array.</li>
<li>Semantics: <strong>lazy</strong> by default. <code><a href="reference/as.matrix.mlx.html">as.matrix.mlx()</a></code> (and some other conversions) <strong>force evaluation</strong>; otherwise, users call <code>mlx_eval(x)</code>.</li>
<li>Operator overloading: arithmetic, matrix algebra, comparisons; plus targeted stats helpers (<code>colMeans.mlx</code>, <code>rowMeans.mlx</code>, <code>crossprod.mlx</code>, <code>tcrossprod.mlx</code>, <code>t.mlx</code>, <code>sum.mlx</code>, <code>mean.mlx</code>).</li>
<li>Phase 1: low-level arrays + ops, evaluation, conversions, basic reductions, tests, doc. (Autodiff/optimizers reserved for a later phase, not implemented now.)</li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestones">Milestones<a class="anchor" aria-label="anchor" href="#milestones"></a></h2>
<ol style="list-style-type: decimal"><li><strong>Scaffold &amp; toolchain</strong></li>
<li><strong>C++ core: array handle, create/convert/eval</strong></li>
<li><strong>Binary ops &amp; reductions</strong></li>
<li><strong>Matrix algebra &amp; helpers</strong></li>
<li><strong>R S3 class + operator overloading</strong></li>
<li><strong>Indexing, printing, and diagnostics</strong></li>
<li><strong>Device/stream management</strong></li>
<li><strong>Docs, examples, tests</strong></li>
<li><strong>Build, local check, packaging</strong></li>
</ol><p>Each milestone below lists atomic tasks.</p>
<hr></div>
<div class="section level2">
<h2 id="milestone-1--scaffold--toolchain">Milestone 1 — Scaffold &amp; toolchain<a class="anchor" aria-label="anchor" href="#milestone-1--scaffold--toolchain"></a></h2>
<p><strong>T1. Create package skeleton</strong></p>
<ul><li>
<p>Create standard R package layout:</p>
<pre><code><span><span class="va">Rmlx</span><span class="op">/</span></span>
<span>  <span class="va">R</span><span class="op">/</span></span>
<span>  <span class="va">src</span><span class="op">/</span></span>
<span>  <span class="va">inst</span><span class="op">/</span></span>
<span>  <span class="va">man</span><span class="op">/</span></span>
<span>  <span class="va">tests</span><span class="op">/</span><span class="va">testthat</span><span class="op">/</span></span>
<span>  <span class="va">vignettes</span><span class="op">/</span></span>
<span>  <span class="va">DESCRIPTION</span></span>
<span>  <span class="va">NAMESPACE</span></span>
<span>  <span class="va">.Rbuildignore</span></span>
<span>  <span class="va">.gitignore</span></span>
<span>  <span class="va">configure</span>     <span class="co"># POSIX shell</span></span>
<span>  <span class="va">cleanup</span>       <span class="co"># optional</span></span></code></pre>
</li>
<li><p>Acceptance: <code>R CMD build</code> produces a tarball; <code>R CMD check</code> runs (expect skips for missing MLX until T3/T4 add detection).</p></li>
</ul><p><strong>T2. DESCRIPTION</strong></p>
<ul><li>
<p>Minimal fields:</p>
<ul><li><code>Package: Rmlx</code></li>
<li><code>Type: Package</code></li>
<li><code>Title: R Interface to Apple's MLX Arrays (GPU-Accelerated on Apple Silicon)</code></li>
<li><code>Version: 0.0.0.9000</code></li>
<li><code>Authors@R: person("First","Last", role=c("aut","cre"), email="you@example.com")</code></li>
<li><code>Description: S3 class 'mlx' backed by Apple MLX arrays with lazy GPU ops via Rcpp.</code></li>
<li><code>License: MIT + file LICENSE</code></li>
<li><code>Encoding: UTF-8</code></li>
<li><code>Depends: R (&gt;= 4.1.0)</code></li>
<li><code>Imports: Rcpp (&gt;= 1.0.10)</code></li>
<li><code>LinkingTo: Rcpp</code></li>
<li><code>Suggests: testthat (&gt;= 3.0.0), knitr, rmarkdown</code></li>
<li><code>Config/testthat/edition: 3</code></li>
<li><code>SystemRequirements: MLX (Apple Machine Learning eXchange) with C/C++ headers and library; macOS on Apple Silicon</code></li>
</ul></li>
<li><p>Acceptance: <code>R CMD check</code> reads DESCRIPTION cleanly.</p></li>
</ul><p><strong>T3. NAMESPACE</strong></p>
<ul><li>
<p>Start with:</p>
<pre><code><span><span class="fu">useDynLib</span><span class="op">(</span><span class="va">Rmlx</span>, .registration <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">importFrom</span><span class="op">(</span><span class="va">Rcpp</span>, <span class="va">sourceCpp</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">print</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">as.matrix</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">colMeans</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">rowMeans</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">t</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">sum</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">mean</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">crossprod</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">tcrossprod</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">Ops</span>, <span class="va">mlx</span><span class="op">)</span></span>
<span><span class="fu">S3method</span><span class="op">(</span><span class="va">MatMult</span>, <span class="va">mlx</span><span class="op">)</span>       <span class="co"># custom for %*% (see T17)</span></span></code></pre>
</li>
<li><p>We’ll also register <code>%*%</code> for <code>mlx</code> via <code>setMethod</code> pattern in R (see T17).</p></li>
</ul><p><strong>T4. Build-time MLX detection (<code>configure</code>)</strong></p>
<ul><li>
<p>Implement POSIX shell <code>configure</code> that:</p>
<ul><li><p>Looks for MLX headers &amp; libs (probe typical locations: <code>/opt/homebrew/include</code>, <code>/opt/homebrew/lib</code>, <code>/usr/local/include</code>, <code>/usr/local/lib</code>, <code>xcrun -sdk macosx --show-sdk-path</code>).</p></li>
<li>
<p>Allows env overrides:</p>
<ul><li>
<code>MLX_INCLUDE</code>, <code>MLX_LIB_DIR</code>, <code>MLX_LIBS</code> (e.g., <code>-lmlx -lc++</code>)</li>
</ul></li>
<li><p>Writes <code>src/Makevars</code> with <code>PKG_CPPFLAGS</code> including <code>-I...</code> and <code>PKG_LIBS</code> including <code>-L... -lmlx</code>.</p></li>
</ul></li>
<li><p>Add a <strong>helpful error</strong> if not found: write a small header check and fail with a message telling the user to install MLX (Homebrew tap or Apple docs).</p></li>
<li><p>Acceptance: <code>R CMD INSTALL .</code> fails gracefully if MLX missing; succeeds when include+lib provided.</p></li>
</ul><blockquote>
<p>Gotcha: keep <code>Makevars</code> minimal and platform-guarded; do not hardcode Intel paths.</p>
</blockquote>
<hr></div>
<div class="section level2">
<h2 id="milestone-2--c-core-array-handle-createconverteval">Milestone 2 — C++ core: array handle, create/convert/eval<a class="anchor" aria-label="anchor" href="#milestone-2--c-core-array-handle-createconverteval"></a></h2>
<p><strong>T5. Define C++ wrapper class &amp; finalizer</strong></p>
<ul><li><p>File: <code>src/mlx_bindings.cpp</code>, plus a header <code>src/mlx_bindings.hpp</code>.</p></li>
<li>
<p>Create a thin RAII wrapper around MLX array handle (consult MLX C API names; assume types like <code>mlx_array*</code>):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">struct</span> MlxArray <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  mlx_array<span class="op">*</span> ptr<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  MlxArray<span class="op">();</span>                       <span class="co">// null</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="kw">explicit</span> MlxArray<span class="op">(</span>mlx_array<span class="op">*</span> p<span class="op">);</span>  <span class="co">// takes ownership</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="op">~</span>MlxArray<span class="op">();</span>                      <span class="co">// calls mlx_array_free(ptr)</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  MlxArray<span class="op">(</span><span class="at">const</span> MlxArray<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  MlxArray<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> MlxArray<span class="op">&amp;)</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  MlxArray<span class="op">(</span>MlxArray<span class="op">&amp;&amp;)</span> <span class="kw">noexcept</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  MlxArray<span class="op">&amp;</span> <span class="kw">operator</span><span class="op">=(</span>MlxArray<span class="op">&amp;&amp;)</span> <span class="kw">noexcept</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
</li>
<li><p>Expose as external pointer to R with a finalizer that deletes the <code>MlxArray</code>.</p></li>
<li><p>Acceptance: Creating and garbage-collecting an <code>mlx</code> object does not leak (use valgrind locally if possible).</p></li>
</ul><p><strong>T6. Create MLX array from R data</strong></p>
<ul><li>
<p>Rcpp-exposed functions (C++):</p>
<ul><li>
<p><code>SEXP cpp_mlx_from_numeric(SEXP x, SEXP dim, SEXP dtype, SEXP device);</code></p>
<ul><li>Inputs: <code>x</code> as <code>NumericVector</code> (contiguous), <code>dim</code> as <code>IntegerVector</code>, <code>dtype</code> string (“float32”/“float64”), <code>device</code> string (“gpu”/“cpu”).</li>
<li>Create MLX array with given shape and copy host data.</li>
</ul></li>
<li><p><code>SEXP cpp_mlx_empty(SEXP dim, SEXP dtype, SEXP device);</code></p></li>
</ul></li>
<li><p>Acceptance: <code>as_mlx(matrix(...))</code> returns an <code>mlx</code> with matching shape and dtype.</p></li>
</ul><p><strong>T7. Copy MLX array back to R</strong></p>
<ul><li>
<p>Function:</p>
<ul><li>
<p><code>SEXP cpp_mlx_to_numeric(SEXP x);</code></p>
<ul><li>Ensure <strong>evaluation</strong> first (see T8). Then copy to <code>NumericVector</code> (column-major like R).</li>
</ul></li>
</ul></li>
<li><p>Acceptance: <code>as.matrix.mlx(x)</code> yields identical values to input after a roundtrip.</p></li>
</ul><p><strong>T8. Evaluation</strong></p>
<ul><li>
<p>Implement:</p>
<ul><li>
<code>void cpp_mlx_eval(SEXP x);</code> (force compute &amp; sync).</li>
</ul></li>
<li><p>Design: store a “needs_eval” flag inside the wrapper, or rely on MLX’s own state; call MLX <code>eval</code> on the array or current graph root.</p></li>
<li>
<p>R side:</p>
<ul><li>
<code>mlx_eval(x)</code> calls into <code>cpp_mlx_eval</code>.</li>
<li>
<code><a href="reference/as.matrix.mlx.html">as.matrix.mlx()</a></code> <strong>must</strong> call <code><a href="reference/mlx_eval.html">mlx_eval()</a></code> before copying.</li>
</ul></li>
<li><p>Acceptance: Composed lazy ops only compute once evaluated or converted.</p></li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-3--binary-ops--reductions">Milestone 3 — Binary ops &amp; reductions<a class="anchor" aria-label="anchor" href="#milestone-3--binary-ops--reductions"></a></h2>
<p><strong>T9. Elementwise unary ops</strong></p>
<ul><li><p>C++ functions: <code>neg</code>, <code>abs</code>, <code>sqrt</code>, <code>exp</code>, <code>log</code>, <code>sin</code>, <code>cos</code>, etc.</p></li>
<li>
<p>Signature pattern:</p>
<ul><li><code>SEXP cpp_mlx_unary(SEXP x, std::string op); // op ∈ {"neg","exp","log",...}</code></li>
</ul></li>
<li><p>Implementation maps to MLX C API unary ops; output matches input dtype unless op requires float.</p></li>
</ul><p><strong>T10. Elementwise binary ops</strong></p>
<ul><li><p>Support: <code>+ - * / ^</code> and comparisons <code>&lt; &lt;= &gt; &gt;= == !=</code>.</p></li>
<li>
<p>Signature:</p>
<ul><li><code>SEXP cpp_mlx_binary(SEXP x, SEXP y, std::string op);</code></li>
<li>Broadcasting rules: Follow MLX’s broadcasting (like NumPy). Validate shapes; throw R error on incompatible shapes.</li>
</ul></li>
<li><p>For scalar RHS/LHS, allow numeric and logical scalars (will wrap in 0-d/1-d MLX arrays or handle as scalar op if MLX supports).</p></li>
</ul><p><strong>T11. Reductions</strong></p>
<ul><li><p>Support: <code>sum</code>, <code>mean</code> (overall and along axes), <code>min</code>, <code>max</code>.</p></li>
<li>
<p>Signatures:</p>
<ul><li>
<code>SEXP cpp_mlx_reduce(SEXP x, std::string op);</code> // full reduction -&gt; scalar mlx</li>
<li><code>SEXP cpp_mlx_reduce_axis(SEXP x, std::string op, int axis, bool keepdims);</code></li>
</ul></li>
<li><p>R wrappers will provide <code>sum.mlx</code>, <code>mean.mlx</code>, and helper <code>colMeans.mlx</code> / <code>rowMeans.mlx</code> built on axis reductions.</p></li>
<li><p>Acceptance: Numerically matches R within tolerance for random small arrays.</p></li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-4--matrix-algebra--helpers">Milestone 4 — Matrix algebra &amp; helpers<a class="anchor" aria-label="anchor" href="#milestone-4--matrix-algebra--helpers"></a></h2>
<p><strong>T12. Transpose, reshape</strong></p>
<ul><li><code>SEXP cpp_mlx_transpose(SEXP x);</code></li>
<li><code>SEXP cpp_mlx_reshape(SEXP x, SEXP new_dim);</code></li>
</ul><p><strong>T13. Matrix multiply</strong></p>
<ul><li>
<p><code>SEXP cpp_mlx_matmul(SEXP a, SEXP b);</code></p>
<ul><li>Accept shapes: (m×k) %*% (k×n) → (m×n); vectors where meaningful (k)×(k) → scalar.</li>
<li>Use MLX matmul op; ensure float32/float64 supported.</li>
</ul></li>
</ul><p><strong>T14. Crossprod &amp; tcrossprod</strong></p>
<ul><li><p>Implement on top of <code>matmul</code> + <code>transpose</code>, but exploit MLX fused ops if available later.</p></li>
<li>
<p>R wrappers:</p>
<ul><li>
<code>crossprod.mlx(x, y = NULL)</code> → <code>t(x) %*% (y %||% x)</code>
</li>
<li>
<code>tcrossprod.mlx(x, y = NULL)</code> → <code>x %*% t(y %||% x)</code>
</li>
</ul></li>
</ul><p><strong>T15. <code>t.mlx</code>, <code>colMeans.mlx</code>, <code>rowMeans.mlx</code></strong></p>
<ul><li>
<code>t.mlx</code> → transpose</li>
<li>
<code>colMeans.mlx</code> → <code>mean(x, axis=0)</code> assuming R column-major (verify axis mapping; likely axis=0 == rows; be explicit and test).</li>
<li>
<code>rowMeans.mlx</code> → <code>mean(x, axis=1)</code> (ditto).</li>
<li>Document axis semantics clearly.</li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-5--r-s3-class--operator-overloading">Milestone 5 — R S3 class + operator overloading<a class="anchor" aria-label="anchor" href="#milestone-5--r-s3-class--operator-overloading"></a></h2>
<p><strong>T16. Class constructors &amp; converters (R)</strong></p>
<ul><li>
<p>File: <code>R/class.R</code></p>
<ul><li><p><code>new_mlx &lt;- function(ptr, dim, dtype, device) { structure(list(ptr=ptr, dim=dim, dtype=dtype, device=device), class="mlx") }</code></p></li>
<li>
<p><code>as_mlx &lt;- function(x, dtype=c("float32","float64"), device=c("gpu","cpu"))</code></p>
<ul><li>Coerce <code>matrix</code>/<code>array</code>/<code>numeric</code> into MLX via <code>cpp_mlx_from_numeric</code>.</li>
</ul></li>
<li><p><code>as.matrix.mlx &lt;- function(x, ...) { mlx_eval(x); cpp_mlx_to_numeric(x$ptr) |&gt; structure(dim=x$dim) }</code></p></li>
<li><p><code>mlx_eval &lt;- function(x) { cpp_mlx_eval(x$ptr); invisible(x) }</code></p></li>
<li><p><code>is.mlx &lt;- function(x) inherits(x, "mlx")</code></p></li>
</ul></li>
</ul><p><strong>T17. Operator overloading</strong></p>
<ul><li>
<p>File: <code>R/ops.R</code></p>
<ul><li>
<p>Define S3 method for <strong><code>Ops.mlx</code></strong> to dispatch elementwise + comparisons.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Ops.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="va">.Generic</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># unary ops: "+" (no-op), "-" (neg)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">op</span> <span class="op">==</span> <span class="st">"+"</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">e1</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">op</span> <span class="op">==</span> <span class="st">"-"</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">.mlx_unary</span><span class="op">(</span><span class="va">e1</span>, <span class="st">"neg"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Unary op '%s' not supported for mlx"</span>, <span class="va">op</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># Coerce scalars/matrix to mlx</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="reference/is.mlx.html">is.mlx</a></span><span class="op">(</span><span class="va">e1</span><span class="op">)</span><span class="op">)</span> <span class="va">e1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/as_mlx.html">as_mlx</a></span><span class="op">(</span><span class="va">e1</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="reference/is.mlx.html">is.mlx</a></span><span class="op">(</span><span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="va">e2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/as_mlx.html">as_mlx</a></span><span class="op">(</span><span class="va">e2</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">op</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"+"</span>,<span class="st">"-"</span>,<span class="st">"*"</span>,<span class="st">"/"</span>,<span class="st">"^"</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">.mlx_binary</span><span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span>, <span class="va">op</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">op</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"=="</span>,<span class="st">"!="</span>,<span class="st">"&lt;"</span>,<span class="st">"&lt;="</span>,<span class="st">"&gt;"</span>,<span class="st">"&gt;="</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">.mlx_binary</span><span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span>, <span class="va">op</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Op '%s' not supported for mlx"</span>, <span class="va">op</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Helper R wrappers call into C++:</p>
<ul><li><code>.mlx_unary &lt;- function(x, op) new_mlx(cpp_mlx_unary(x$ptr, op), x$dim, x$dtype, x$device)</code></li>
<li><code>.mlx_binary &lt;- function(x, y, op) new_mlx(cpp_mlx_binary(x$ptr, y$ptr, op), broadcast_dim(x,y), promote_dtype(x,y), common_device(x,y))</code></li>
</ul></li>
</ul></li>
<li>
<p><strong>Matrix multiply <code>%*%</code></strong></p>
<ul><li>
<p>In base R <code>%*%</code> is a primitive; define an S3 generic shim:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`%*%.mlx`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="reference/is.mlx.html">is.mlx</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/as_mlx.html">as_mlx</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="reference/is.mlx.html">is.mlx</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/as_mlx.html">as_mlx</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="reference/new_mlx.html">new_mlx</a></span><span class="op">(</span><span class="fu">cpp_mlx_matmul</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">ptr</span>, <span class="va">y</span><span class="op">$</span><span class="va">ptr</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">dim</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span>, <span class="va">y</span><span class="op">$</span><span class="va">dim</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">$</span><span class="va">dim</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="fu">promote_dtype</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span>, <span class="fu">common_device</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Register in <code>.onLoad</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Ensure our method is visible for dispatch</span></span>
<span>  <span class="co"># (S3 method for primitive is recognized if named `%*%.mlx`)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
</ul></li>
</ul><p><strong>T18. Stats helpers</strong></p>
<ul><li>
<p>File: <code>R/stats.R</code></p>
<ul><li>
<code>sum.mlx</code>, <code>mean.mlx</code> → reductions (full).</li>
<li>
<code>colMeans.mlx</code>, <code>rowMeans.mlx</code> → axis reductions + <code>drop=TRUE</code> to return 1D <code>mlx</code> (dim of length 1 removed) or keepdims + reshape.</li>
<li>
<code>t.mlx</code> → transpose wrapper.</li>
<li>
<code>crossprod.mlx</code>, <code>tcrossprod.mlx</code>.</li>
</ul></li>
</ul><p><strong>T19. Class utilities</strong></p>
<ul><li>
<p>File: <code>R/utils.R</code></p>
<ul><li>
<code>print.mlx</code> → show shape, dtype, device, lazy/evaluated flag; show small preview (e.g., up to 6×6) by evaluating a small slice only (or optionally evaluate fully if size small).</li>
<li>
<code>str.mlx</code> → concise structure.</li>
</ul></li>
<li><p>Acceptance: Arithmetic, comparisons, <code>%*%</code>, col/row means and reductions work between mlx/regular R objects, producing an <code>mlx</code> until user calls <code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix()</a></code> or <code><a href="reference/mlx_eval.html">mlx_eval()</a></code>.</p></li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-6--indexing-printing-diagnostics">Milestone 6 — Indexing, printing, diagnostics<a class="anchor" aria-label="anchor" href="#milestone-6--indexing-printing-diagnostics"></a></h2>
<p><strong>T20. Indexing <code>[ ]</code></strong></p>
<ul><li>
<p>R method:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`[.mlx`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">i</span>, <span class="va">j</span>, <span class="va">...</span>, <span class="va">drop</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Convert missing to full spans, build slices, call C++ slice</span></span>
<span>  <span class="fu"><a href="reference/new_mlx.html">new_mlx</a></span><span class="op">(</span><span class="fu">cpp_mlx_slice</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">ptr</span>, <span class="fu">normalize_index</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="fu">normalize_index</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">)</span>, <span class="va">new_dim</span>, <span class="va">x</span><span class="op">$</span><span class="va">dtype</span>, <span class="va">x</span><span class="op">$</span><span class="va">device</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>C++: <code>SEXP cpp_mlx_slice(SEXP x, SEXP i_, SEXP j_);</code></p>
<ul><li>Support integer/real/logical vectors; negative indices throw (or translate).</li>
<li>Use MLX slicing ops (start/stop/step per axis).</li>
</ul></li>
<li><p>Acceptance: <code>x[ ,1]</code>, <code>x[1:5, 3:7]</code>, logical masks for rows/cols (optional in v1) behave; returns <code>mlx</code>.</p></li>
</ul><p><strong>T21. Shape/dtype accessors</strong></p>
<ul><li>
<p>R:</p>
<ul><li><code>mlx_dim &lt;- function(x) x$dim</code></li>
<li><code>mlx_dtype &lt;- function(x) x$dtype</code></li>
<li>
<code>dim.mlx &lt;- function(x) x$dim</code> (S3)</li>
<li><code>length.mlx &lt;- function(x) prod(x$dim)</code></li>
</ul></li>
</ul><p><strong>T22. Error messages</strong></p>
<ul><li>Ensure all C++ functions translate exceptions to R errors with actionable messages: incompatible shapes, dtype mismatch, not found MLX op, etc.</li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-7--devicestream-management">Milestone 7 — Device/stream management<a class="anchor" aria-label="anchor" href="#milestone-7--devicestream-management"></a></h2>
<p><strong>T23. Default device</strong></p>
<ul><li>
<p>R:</p>
<ul><li><code>mlx_default_device &lt;- local({ dev &lt;- "gpu"; function(value) { if (!missing(value)) dev &lt;&lt;- match.arg(value, c("gpu","cpu")); dev }})</code></li>
<li>Used by <code><a href="reference/as_mlx.html">as_mlx()</a></code> and constructors if device not specified.</li>
</ul></li>
<li>
<p>C++:</p>
<ul><li>Keep references to MLX CPU/GPU streams (e.g., <code>MLX_GPU_STREAM</code>, <code>MLX_CPU_STREAM</code> identifiers). Make a small helper to select stream per call.</li>
</ul></li>
<li><p>Acceptance: Users can switch default to CPU for debugging; all ops route accordingly.</p></li>
</ul><p><strong>T24. Synchronization</strong></p>
<ul><li>R: <code>mlx_synchronize(device=c("gpu","cpu"))</code> → C++ call to stream/device synchronize (if MLX exposes this).</li>
<li>Acceptance: No outstanding work remains after synchronize.</li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-8--docs-examples-tests">Milestone 8 — Docs, examples, tests<a class="anchor" aria-label="anchor" href="#milestone-8--docs-examples-tests"></a></h2>
<p><strong>T25. Roxygen2 docs</strong></p>
<ul><li>Add <code>#'</code> docs for all user-facing functions: <code>as_mlx</code>, <code>as.matrix.mlx</code>, <code>mlx_eval</code>, ops overview, <code>%*%</code>, <code>colMeans.mlx</code>, <code>rowMeans.mlx</code>, etc.</li>
<li>
<code>?mlx</code> overview man page: explain laziness, evaluation points, device selection, and unified memory concept.</li>
</ul><p><strong>T26. Vignette</strong></p>
<ul><li>
<p><code>vignettes/getting-started.Rmd</code></p>
<ul><li>Walkthrough: creating <code>mlx</code> arrays, arithmetic, <code>%*%</code>, reductions, <code>colMeans</code>, evaluation/convert, simple timing demo vs base R for large matmul (note: not a formal benchmark).</li>
<li>State Apple-only requirement.</li>
</ul></li>
</ul><p><strong>T27. Tests (testthat)</strong></p>
<ul><li>
<p>Skip tests if MLX unavailable or device not GPU:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">skip_if_not</span><span class="op">(</span><span class="fu">mlx_available</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Tests:</p>
<ul><li>Roundtrip <code>as_mlx</code> → <code>as.matrix</code> equality.</li>
<li>Elementwise ops vs base R (small sizes).</li>
<li>
<code>%*%</code> correctness vs base R.</li>
<li>
<code>colMeans/rowMeans/sum/mean</code> equality vs base R.</li>
<li>Broadcasting cases.</li>
<li>Indexing behavior.</li>
</ul></li>
<li><p>Tolerances: use <code>expect_equal(..., tolerance = 1e-6)</code>.</p></li>
</ul><hr></div>
<div class="section level2">
<h2 id="milestone-9--build-local-check-packaging">Milestone 9 — Build, local check, packaging<a class="anchor" aria-label="anchor" href="#milestone-9--build-local-check-packaging"></a></h2>
<p><strong>T28. Local build</strong></p>
<ul><li>
<p>Commands:</p>
<ul><li><code>R CMD build .</code></li>
<li><code>R CMD INSTALL Rmlx_0.0.0.9000.tar.gz</code></li>
<li><code>R CMD check Rmlx_0.0.0.9000.tar.gz --as-cran</code></li>
</ul></li>
<li><p>Accept: no ERRORs; NOTE/WARN only for SystemRequirements acceptable.</p></li>
</ul><p><strong>T29. Minimal examples</strong></p>
<ul><li>Add examples to function docs that run fast and only touch small arrays to avoid GPU timeouts.</li>
</ul><hr></div>
<div class="section level2">
<h2 id="file-by-file-stubs-for-the-agent">File-by-file stubs (for the agent)<a class="anchor" aria-label="anchor" href="#file-by-file-stubs-for-the-agent"></a></h2>
<p><strong>R/class.R</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Create MLX array from R object</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">as_mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">dtype</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"float32"</span>,<span class="st">"float64"</span><span class="op">)</span>, <span class="va">device</span> <span class="op">=</span> <span class="fu"><a href="reference/mlx_default_device.html">mlx_default_device</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dtype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">dtype</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="reference/is.mlx.html">is.mlx</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">is.vector</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">else</span> <span class="va">dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">dim</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ptr</span> <span class="op">&lt;-</span> <span class="fu">cpp_mlx_from_numeric</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">dim</span><span class="op">)</span>, <span class="va">dtype</span>, <span class="va">device</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ptr <span class="op">=</span> <span class="va">ptr</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">dim</span><span class="op">)</span>, dtype <span class="op">=</span> <span class="va">dtype</span>, device <span class="op">=</span> <span class="va">device</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"mlx"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Force evaluation</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">mlx_eval</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="reference/is.mlx.html">is.mlx</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>; <span class="fu">cpp_mlx_eval</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">ptr</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="co">#' Convert MLX array to base matrix/array</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">as.matrix.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="reference/mlx_eval.html">mlx_eval</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">cpp_mlx_to_numeric</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">ptr</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">dim</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">is.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"mlx"</span><span class="op">)</span></span></code></pre></div>
<p><strong>R/ops.R</strong> (skeleton shown earlier)</p>
<p><strong>R/stats.R</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">sum.mlx</span>  <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">.mlx_reduce</span><span class="op">(</span><span class="va">x</span>, <span class="st">"sum"</span><span class="op">)</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">mean.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">.mlx_reduce</span><span class="op">(</span><span class="va">x</span>, <span class="st">"mean"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">colMeans.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">dims</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">.mlx_reduce_axis</span><span class="op">(</span><span class="va">x</span>, <span class="st">"mean"</span>, axis <span class="op">=</span> <span class="fl">0L</span>, keepdims <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">rowMeans.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">dims</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">.mlx_reduce_axis</span><span class="op">(</span><span class="va">x</span>, <span class="st">"mean"</span>, axis <span class="op">=</span> <span class="fl">1L</span>, keepdims <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">t.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="reference/new_mlx.html">new_mlx</a></span><span class="op">(</span><span class="fu">cpp_mlx_transpose</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">ptr</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">dim</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">dtype</span>, <span class="va">x</span><span class="op">$</span><span class="va">device</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">crossprod.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span>; <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">y</span> <span class="op">}</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">tcrossprod.mlx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span>; <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">}</span></span></code></pre></div>
<p><strong>src/Makevars</strong> (generated by <code>configure</code>)</p>
<pre><code>PKG_CPPFLAGS = -I$(MLX_INCLUDE)
PKG_LIBS     = -L$(MLX_LIB_DIR) -lmlx</code></pre>
<p><strong>src/registration.cpp</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">// forward-declare C++ functions to register with R</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">// RCPP_MODULE / R_registerRoutines as needed</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="at">extern</span> <span class="st">"C"</span> <span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  <span class="dt">void</span> R_init_Rmlx<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> TRUE<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>src/mlx_bindings.cpp</strong> (sketch)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">"mlx_bindings.hpp"</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;mlx/c_api.h&gt;</span><span class="pp">  </span><span class="co">// adjust include path per installed MLX</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">// Helpers to unwrap/wrap external pointers, set dims/dtype/device (store those in R side)</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>SEXP cpp_mlx_from_numeric<span class="op">(</span>SEXP <span class="va">x_</span><span class="op">,</span> SEXP <span class="va">dim_</span><span class="op">,</span> SEXP <span class="va">dtype_</span><span class="op">,</span> SEXP <span class="va">device_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  NumericVector x<span class="op">(</span><span class="va">x_</span><span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  IntegerVector dim<span class="op">(</span><span class="va">dim_</span><span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  <span class="bu">std::</span>string dtype <span class="op">=</span> as<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;(</span><span class="va">dtype_</span><span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  <span class="bu">std::</span>string device <span class="op">=</span> as<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;(</span><span class="va">device_</span><span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>  <span class="co">// create MLX array with given shape and dtype on device</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>  <span class="co">// copy x.data() into MLX array</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>  <span class="co">// return XPtr&lt;MlxArray&gt;(new MlxArray(ptr), true)</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>SEXP cpp_mlx_to_numeric<span class="op">(</span>SEXP <span class="va">xp_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="co">// ensure evaluated</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>  <span class="co">// copy MLX array data to NumericVector</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a><span class="dt">void</span> cpp_mlx_eval<span class="op">(</span>SEXP <span class="va">xp_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>  <span class="co">// call MLX eval on underlying array/graph</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a><span class="co">// unary, binary, reduce, reduce_axis, transpose, reshape, matmul, slice...</span></span></code></pre></div>
<hr></div>
<div class="section level2">
<h2 id="acceptance-checklist-phase-1-complete">Acceptance checklist (Phase 1 complete)<a class="anchor" aria-label="anchor" href="#acceptance-checklist-phase-1-complete"></a></h2>
<ul class="task-list"><li><label><input type="checkbox">Build succeeds on Apple Silicon with MLX installed.</label></li>
<li><label><input type="checkbox"><code><a href="reference/as_mlx.html">as_mlx()</a></code>, <code><a href="reference/as.matrix.mlx.html">as.matrix.mlx()</a></code> roundtrip correct.</label></li>
<li><label><input type="checkbox"><code>+ - * / ^</code>, comparisons, <code>%*%</code> produce correct results vs base R (small sizes).</label></li>
<li><label><input type="checkbox"><code>sum.mlx</code>, <code>mean.mlx</code>, <code>colMeans.mlx</code>, <code>rowMeans.mlx</code>, <code>t.mlx</code>, <code>crossprod.mlx</code>, <code>tcrossprod.mlx</code> correct.</label></li>
<li><label><input type="checkbox">Lazy by default; <code><a href="reference/as.matrix.mlx.html">as.matrix.mlx()</a></code> forces evaluation; <code><a href="reference/mlx_eval.html">mlx_eval()</a></code> works.</label></li>
<li><label><input type="checkbox">Indexing <code>[]</code> supports common cases.</label></li>
<li><label><input type="checkbox">Helpful errors if MLX not found at install, or shape/dtype mismatches at runtime.</label></li>
<li><label><input type="checkbox">Vignette explains usage and caveats.</label></li>
</ul><hr></div>
<div class="section level2">
<h2 id="risks--notes-for-the-agent">Risks &amp; notes for the agent<a class="anchor" aria-label="anchor" href="#risks--notes-for-the-agent"></a></h2>
<ul><li>
<strong>MLX headers &amp; symbols:</strong> Ensure correct include (e.g., <code>#include &lt;mlx/c_api.h&gt;</code>) and link flags; the actual header path &amp; lib name may vary; keep <code>configure</code> flexible with env overrides.</li>
<li>
<strong>Dtype:</strong> R is <code>double</code> by default; we’ll allow <code>float32</code> and <code>float64</code>. Decide default (<code>float32</code> is faster on GPU; but to match R expectations, maybe default <code>float64</code>; document choice).</li>
<li>
<strong>Axis conventions:</strong> Confirm MLX axis numbering vs R’s column-major expectations; lock this down with tests for <code>colMeans/rowMeans</code>.</li>
<li>
<strong>Broadcasting:</strong> Implement consistent rules; add tests for scalar + array, vector + matrix.</li>
<li>
<strong>Evaluation semantics:</strong> If MLX needs explicit graph roots or streams for <code>eval</code>, store whatever handle is required with each array (or a per-session singleton), and make <code>cpp_mlx_eval</code> robust.</li>
<li>
<strong>Thread safety:</strong> Rcpp calls execute on R main thread; ensure MLX usage is safe in that context.</li>
<li>
<strong>Indexing:</strong> Logical indexing may be deferred; start with integer ranges and <code>:</code> slices.</li>
</ul><hr></div>
<div class="section level2">
<h2 id="phase-2-later-not-in-scope-for-this-handoff">Phase 2 (later, not in scope for this handoff)<a class="anchor" aria-label="anchor" href="#phase-2-later-not-in-scope-for-this-handoff"></a></h2>
<ul><li>Autodiff: wrap MLX grad transforms; expose <code>mlx_grad(fn, params)</code> for R closures or provide graph-based differentiation APIs.</li>
<li>Optimizers: SGD/Adam on <code>mlx</code> parameters.</li>
<li>More linalg: <code>solve</code>, <code>chol</code>, <code>svd</code>, <code>eigen</code> (depending on MLX support).</li>
<li>Datasets/dataloaders, random seeding, fused kernels, compilation.</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

