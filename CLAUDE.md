# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Package Overview

Rmlx is an R interface to Apple's MLX (Machine Learning eXchange) library for GPU-accelerated array operations on Apple Silicon. The package provides lazy evaluation, S3 operator overloading, and familiar R syntax for GPU computing.

**Requirements:**
- macOS on Apple Silicon (M1/M2/M3+)
- MLX C/C++ library installed
- Rcpp for R/C++ integration

## Development Commands

### Building and Testing
- `R -q -e 'Rcpp::compileAttributes()'` - Generate Rcpp exports after modifying C++ code (ALWAYS run this first)
- `R -q -e 'devtools::document()'` - Generate documentation from roxygen comments
- `R -q -e 'devtools::load_all()'` - Load package for interactive development
- `R -q -e 'devtools::build()'` - Build the package
- `R -q -e 'devtools::check()'` - Run R CMD check
- `R -q -e 'devtools::test()'` - Run tests

### Installing
- `R -q -e 'devtools::install()'` - Install package locally (requires MLX)

## System Requirements

### MLX Installation
The package requires MLX headers and library. Configure script searches:
- `/opt/homebrew/include/mlx/c/mlx.h` (headers)
- `/opt/homebrew/lib/libmlx.dylib` (library)
- `/usr/local/include`, `/usr/local/lib` (alternatives)

Override with environment variables:
```bash
export MLX_INCLUDE=/path/to/mlx/include
export MLX_LIB_DIR=/path/to/mlx/lib
export MLX_LIBS="-lmlx"
```

### Build Process
1. `configure` script detects MLX and writes `src/Makevars`
2. `cleanup` script removes generated `src/Makevars`
3. Build fails gracefully with helpful error if MLX not found

## Architecture

### C++ Core (`src/`)
- `mlx_bindings.hpp/cpp` - RAII wrapper, array creation, conversion, evaluation
- `mlx_ops.cpp` - Unary ops, binary ops, reductions, matrix ops, slicing
- `init.cpp` - R package registration
- `RcppExports.cpp` - Auto-generated by `Rcpp::compileAttributes()`

Key design:
- `MlxArray` class wraps `mlx_array*` with RAII semantics
- External pointers to R with finalizers for memory management
- All C++ functions exported via `[[Rcpp::export]]`

### R Code (`R/`)
- `class.R` - S3 class, constructors, converters (`as_mlx`, `as.matrix.mlx`, `mlx_eval`)
- `ops.R` - Operator overloading (`Ops.mlx`, `%*%.mlx`)
- `stats.R` - Reductions and matrix helpers (`sum`, `mean`, `colMeans`, `t`, `crossprod`)
- `utils.R` - Print, indexing `[.mlx`, accessors (`dim`, `length`)
- `device.R` - Device management (`mlx_default_device`, `mlx_synchronize`)
- `Rmlx-package.R` - Package documentation
- `RcppExports.R` - Auto-generated by `Rcpp::compileAttributes()`

### Key Features
1. **Lazy evaluation** - Operations build computation graph; evaluate with `mlx_eval()` or `as.matrix()`
2. **S3 dispatch** - Standard R syntax: `+`, `-`, `*`, `/`, `^`, `%*%`, `t()`, etc.
3. **Broadcasting** - NumPy-style broadcasting for binary ops
4. **GPU/CPU** - Default to GPU; switch with `mlx_default_device()`

### MLX C API Assumptions
The C++ code assumes MLX C API functions like:
- `mlx_array_from_data()`, `mlx_array_free()`, `mlx_array_eval()`
- `mlx_array_add()`, `mlx_array_matmul()`, `mlx_array_transpose()`
- `mlx_array_sum()`, `mlx_array_mean()`, etc.

**IMPORTANT**: The actual MLX C API function names may differ. If compilation errors occur, check MLX documentation and update function names in `src/mlx_bindings.cpp` and `src/mlx_ops.cpp`.

## Common Issues

### MLX headers not found
- Install MLX: `brew install mlx` (if available) or build from source
- Set `MLX_INCLUDE` environment variable
- Check header path is `/path/to/include/mlx/c/mlx.h`

### Wrong MLX function names
- MLX C API may have different naming conventions
- Check `#include <mlx/c/mlx.h>` or equivalent header
- Update function calls in `src/mlx_bindings.cpp` and `src/mlx_ops.cpp`

### Axis confusion (row-major vs column-major)
- R uses column-major order
- MLX uses row-major order
- Tests verify `colMeans`/`rowMeans` map to correct axes
- If tests fail, swap axis=0 and axis=1 in reductions

## Testing

Tests in `tests/testthat/`:
- All tests skip if package can't load (MLX not available)
- Use `tolerance = 1e-6` for floating-point comparisons
- Compare against base R results for correctness

Run specific test file:
```r
R -q -e 'devtools::test_file("tests/testthat/test-ops.R")'
```

## Documentation

- Roxygen2 comments in R files
- Vignette in `vignettes/getting-started.Rmd`
- Examples use `\dontrun{}` since MLX required

After editing docs:
```r
R -q -e 'devtools::document()'
```
- Where possible, use usethis:: package commands to do things the canonical way.
- the array type doesn't have a default constructor!
- When you add a function, update the pkgdown reference index.
- When you add a new function, include a @seealso link to the online mlx documentation, where appropriate.
- You can use library(help = "Rmlx") to find exported R functions in the package, with descriptions of what they do. You can use ls(envir = asNamespace("Rmlx"), all.names = TRUE) to find all functions including unexported ones.
- The url https://ml-explore.github.io/mlx/build/html/search.html?q=foobar will search the documentation for foobar
- Always use markdown in roxygen where possible (e.g. markdown lists rather than \item).